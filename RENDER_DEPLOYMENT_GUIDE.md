# Ecomora Server Deployment Guide - Render

## Overview

This guide explains how to deploy the Ecomora server on Render, a modern cloud platform that
provides automatic builds, deploys, and scaling.

## Prerequisites

1. **Render Account**: Create a free account at [render.com](https://render.com)
2. **GitHub Repository**: Your code should be in a GitHub repository
3. **Git**: Ensure your code is committed and pushed to GitHub

## Deployment Options

### Option 1: Using Blueprint (Recommended)

The easiest way to deploy is using the `render.yaml` blueprint file included in this repository.

#### Steps:

1. **Fork/Clone Repository**: Ensure your code is in a GitHub repository
2. **Connect to Render**:
    - Go to your [Render Dashboard](https://dashboard.render.com)
    - Click "New +" and select "Blueprint"
    - Connect your GitHub repository
    - Select the repository containing your Ecomora server
    - Render will automatically detect the `render.yaml` file

3. **Deploy**: Click "Apply" and Render will:
    - Create a PostgreSQL database
    - Set up Redis for caching
    - Deploy your web service
    - Configure environment variables automatically

### Option 2: Manual Setup

If you prefer to set up services manually:

#### 1. Create PostgreSQL Database

1. Go to your Render dashboard
2. Click "New +" → "PostgreSQL"
3. Configure:
    - **Name**: `ecomora-db`
    - **Database Name**: `ecomora_db`
    - **User**: `ecomora_user`
    - **Region**: Choose closest to your users
    - **Plan**: Start with "Free" for testing

#### 2. Create Redis Instance

1. Click "New +" → "Redis"
2. Configure:
    - **Name**: `ecomora-redis`
    - **Region**: Same as your database
    - **Plan**: Start with "Free"

#### 3. Create Web Service

1. Click "New +" → "Web Service"
2. Connect your GitHub repository
3. Configure:
    - **Name**: `ecomora-server`
    - **Environment**: `Java`
    - **Build Command**: `./gradlew server:shadowJar`
    - **Start Command**: `java -jar server/build/libs/server-all.jar`
    - **Plan**: Start with "Free"

#### 4. Environment Variables

Add these environment variables to your web service:

```
ENV=production
PORT=8080
DATABASE_URL=[Auto-filled from database]
DB_USERNAME=[Auto-filled from database]
DB_PASSWORD=[Auto-filled from database]
JWT_SECRET=[Generate a secure 256-bit secret]
STATIC_FILE_ROOT=/opt/render/project/src/uploads
UPLOAD_DIR=/opt/render/project/src/uploads
```

## Environment Configuration

### Required Environment Variables

| Variable | Description | Example |
|----------|-------------|---------|
| `ENV` | Environment type | `production` |
| `PORT` | Server port | `8080` |
| `DATABASE_URL` | PostgreSQL connection string | Auto-generated by Render |
| `DB_USERNAME` | Database username | Auto-generated by Render |
| `DB_PASSWORD` | Database password | Auto-generated by Render |
| `JWT_SECRET` | JWT signing secret | Generate 256-bit secret |
| `STATIC_FILE_ROOT` | Static files directory | `/opt/render/project/src/uploads` |
| `UPLOAD_DIR` | Upload directory | `/opt/render/project/src/uploads` |

### Optional Environment Variables

| Variable | Description | Default |
|----------|-------------|---------|
| `REDIS_URL` | Redis connection string | Auto-generated by Render |
| `MAX_UPLOAD_SIZE` | Maximum file upload size | `10MB` |
| `LOG_LEVEL` | Logging level | `INFO` |

## Database Setup

### Initial Database Schema

Render PostgreSQL instances come empty. You'll need to initialize your database schema:

1. **Connect to Database**:
   ```bash
   psql [DATABASE_URL]
   ```

2. **Run Schema Script**:
   ```sql
   -- Copy contents of init-db.sql here
   ```

3. **Or use the provided script**:
   ```bash
   psql [DATABASE_URL] < init-db.sql
   ```

### Database Migrations

For future schema changes, you can:

1. Use Render's built-in database dashboard
2. Connect via psql and run migration scripts
3. Implement database migrations in your application code

## File Storage

### Upload Directory

Render provides persistent storage for uploaded files:

- **Path**: `/opt/render/project/src/uploads`
- **Persistence**: Files persist across deployments
- **Access**: Files are accessible via HTTP

### Static File Serving

Configure your application to serve static files from the upload directory:

```kotlin
// In your Ktor application
install(StaticContent) {
    files("uploads")
    files("static")
}
```

## Custom Domain

### Add Custom Domain

1. Go to your web service settings
2. Click "Custom Domains"
3. Add your domain (e.g., `api.yourdomain.com`)
4. Update your DNS records as instructed by Render
5. Render automatically provisions SSL certificates

### SSL/TLS

- **Automatic SSL**: Render automatically provisions and renews SSL certificates
- **HTTP to HTTPS**: Automatic redirect from HTTP to HTTPS
- **Security Headers**: Configure security headers in your application

## Monitoring and Logging

### Built-in Monitoring

Render provides:

- **Logs**: Real-time application logs
- **Metrics**: CPU, memory, and request metrics
- **Health Checks**: Automatic health monitoring
- **Alerts**: Email/Slack notifications for issues

### Health Checks

Ensure your application provides health endpoints:

```kotlin
// Health check endpoint
get("/health") {
    call.respond(HttpStatusCode.OK, mapOf("status" to "healthy"))
}

get("/ready") {
    call.respond(HttpStatusCode.OK, mapOf("status" to "ready"))
}
```

### Logging

Configure structured logging:

```kotlin
// In your logback configuration
<configuration>
    <appender name="STDOUT" class="ch.qos.logback.core.ConsoleAppender">
        <encoder>
            <pattern>%d{HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n</pattern>
        </encoder>
    </appender>
    <root level="INFO">
        <appender-ref ref="STDOUT"/>
    </root>
</configuration>
```

## Scaling

### Horizontal Scaling

1. Go to your web service settings
2. Increase the number of instances
3. Render automatically load balances traffic

### Vertical Scaling

1. Upgrade your plan to get more CPU/memory
2. Available plans:
    - **Free**: 512MB RAM, 0.1 CPU
    - **Starter**: 1GB RAM, 0.5 CPU
    - **Standard**: 2GB RAM, 1 CPU
    - **Pro**: 4GB RAM, 2 CPU

### Database Scaling

1. Upgrade your PostgreSQL plan
2. Available plans:
    - **Free**: 1GB storage, 97 connections
    - **Starter**: 10GB storage, 97 connections
    - **Standard**: 100GB storage, 197 connections

## Security

### Environment Variables

- **Secrets**: Store sensitive data in environment variables
- **JWT Secret**: Generate a strong 256-bit secret
- **Database Credentials**: Use Render's auto-generated credentials

### Network Security

- **Private Networking**: Services within your account can communicate privately
- **SSL/TLS**: Automatic SSL termination
- **DDoS Protection**: Built-in DDoS protection

### Application Security

Implement security best practices:

```kotlin
// CORS configuration
install(CORS) {
    method(HttpMethod.Options)
    method(HttpMethod.Get)
    method(HttpMethod.Post)
    method(HttpMethod.Put)
    method(HttpMethod.Delete)
    method(HttpMethod.Patch)
    header(HttpHeaders.Authorization)
    header(HttpHeaders.ContentType)
    allowCredentials = true
    anyHost() // Configure for production domains
}

// Security headers
install(DefaultHeaders) {
    header("X-Frame-Options", "DENY")
    header("X-Content-Type-Options", "nosniff")
    header("X-XSS-Protection", "1; mode=block")
}
```

## CI/CD

### Automatic Deployments

Render automatically deploys when you push to your connected branch:

1. **Push to GitHub**: Commit and push changes
2. **Automatic Build**: Render detects changes and starts build
3. **Deploy**: Successful builds are automatically deployed
4. **Rollback**: Easy rollback to previous versions

### Build Configuration

Customize your build process:

```yaml
# In render.yaml
buildCommand: |
  ./gradlew clean
  ./gradlew server:shadowJar
  ./gradlew server:test
```

### Deploy Hooks

Set up deploy hooks for notifications:

1. Go to service settings
2. Add deploy hook URL
3. Render will POST to your URL on deployments

## Troubleshooting

### Common Issues

1. **Build Failures**:
    - Check build logs in Render dashboard
    - Ensure all dependencies are correctly specified
    - Verify Java version compatibility

2. **Database Connection Issues**:
    - Verify environment variables are set
    - Check database connection string format
    - Ensure database is running and accessible

3. **File Upload Issues**:
    - Verify upload directory exists
    - Check file permissions
    - Ensure sufficient disk space

### Debug Commands

Connect to your service for debugging:

```bash
# View logs
render logs [service-name]

# Access database
psql [DATABASE_URL]

# Check service status
curl https://your-service-url/health
```

### Performance Issues

1. **Slow Response Times**:
    - Check database query performance
    - Implement caching with Redis
    - Optimize database indexes

2. **Memory Issues**:
    - Monitor memory usage in dashboard
    - Optimize application memory usage
    - Consider upgrading to higher plan

## Migration from Google Cloud

### Database Migration

1. **Export from Cloud SQL**:
   ```bash
   gcloud sql export sql SOURCE_INSTANCE gs://BUCKET_NAME/DATABASE_FILE.sql \
     --database=DATABASE_NAME
   ```

2. **Import to Render**:
   ```bash
   psql [RENDER_DATABASE_URL] < DATABASE_FILE.sql
   ```

### Environment Variables

Update environment variables from Google Cloud format to Render format:

| Google Cloud | Render |
|-------------|---------|
| `INSTANCE_CONNECTION_NAME` | `DATABASE_URL` |
| `DB_USER` | `DB_USERNAME` |
| `DB_PASS` | `DB_PASSWORD` |

### File Storage

If you were using Google Cloud Storage:

1. **Download files from GCS**:
   ```bash
   gsutil -m cp -r gs://your-bucket/* ./uploads/
   ```

2. **Upload to Render**: Files in `/opt/render/project/src/uploads` persist automatically

## Cost Comparison

### Render Pricing

- **Free Tier**: Perfect for development/testing
- **Starter**: $7/month for web service, $7/month for database
- **Standard**: $25/month for web service, $20/month for database

### Benefits over Google Cloud

- **Simplicity**: No complex configuration
- **Automatic SSL**: Free SSL certificates
- **Zero-downtime deploys**: Automatic blue-green deployments
- **Built-in monitoring**: No additional setup required
- **Predictable pricing**: No surprise charges

## Best Practices

### Development Workflow

1. **Local Development**: Use Docker Compose for local development
2. **Staging**: Deploy to Render with staging environment
3. **Production**: Deploy to production with proper monitoring

### Database

1. **Connection Pooling**: Use HikariCP for connection pooling
2. **Indexes**: Create proper database indexes
3. **Backups**: Render automatically backs up databases

### Security

1. **Environment Variables**: Never commit secrets to code
2. **JWT Tokens**: Use secure, long-lived JWT secrets
3. **HTTPS**: Always use HTTPS in production
4. **CORS**: Configure CORS for production domains

## Support

### Render Support

- **Documentation**: [render.com/docs](https://render.com/docs)
- **Community**: [Render Community](https://community.render.com)
- **Support**: Email support for paid plans

### Application Support

- **Logs**: Check application logs in Render dashboard
- **Health Checks**: Monitor health endpoints
- **Monitoring**: Use built-in metrics and alerts